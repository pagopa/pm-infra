# only manual
trigger: none
pr: none

parameters:
  - name: 'ENVIRONMENT'
    displayName: 'Run on selected environment'
    type: string
    default: SIT
    values:
      - sit
      - uat
      - prod
  - name: "METHOD"
    displayName: "METHOD"
    type: string
    default: TRAFFIC_ROUTING
    values:
      - TRAFFIC_ROUTING
      - SWAP
  - name: "TRAFFIC_ROUTING_VALUE_PERCENT"
    displayName: "TRAFFIC_ROUTING_VALUE_PERCENT" 
    type: number
    default: 10
  - name: "pm-appsrv-admin-panel"
    displayName: "admin-panel"
    type: boolean
    values:
      - pm-appsrv-admin-panel
  - name: "pm-appsrv-batch"
    displayName: "batch"
    type: boolean
    values:
      - pm-appsrv-batch
  - name: "pm-appsrv-logging"
    displayName: "logging"
    type: boolean
    values:
      - pm-appsrv-logging
  - name: "pm-appsrv-payment-gateway"
    displayName: "payment-gateway"
    type: boolean
    values:
      - pm-appsrv-payment-gateway
  - name: "pm-appsrv-restapi-io"
    displayName: "restapi-io"
    type: boolean
    values:
      - pm-appsrv-restapi-io
  - name: "pm-appsrv-restapi"
    displayName: "restapi"
    type: boolean
    values:
      - pm-appsrv-restapi
  - name: "pm-appsrv-rtd"
    displayName: "rtd"
    type: boolean
    values:
      - pm-appsrv-rtd
  - name: "pm-appsrv-wisp"
    displayName: "wisp"
    type: boolean
    values:
      - pm-appsrv-wisp


variables:
  TIME_OUT: 5

pool:
  vmImage: 'ubuntu-20.04'

stages:
  - stage: set_app_routing
    jobs: 
      - job: release_routing
        steps:
          - task: AzureCLI@2
            inputs:
              azureSubscription: 'U87-PagoPa-PCI-uat(e7feb90c-fcc2-40a2-ba56-d68ec301c6c0)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: | 
                for app in $(APP_SERVICES); do
                  echo "Set routing to -> $(TRAFFIC_ROUTING) of $app"
                  az webapp traffic-routing set --distribution release=$(TRAFFIC_ROUTING) \
                    --name $app \
                    --resource-group U87-PM-AppServices-pci-uat \
                    --subscription "U87-PagoPa-PCI-uat"
                  if $[ $? == 0 ]; then
                    echo "ROUTED $app"
                  fi  
                done


  - stage: swap_app_services
    dependsOn: [set_app_routing]
    jobs: 
      - job: release_swap
        steps:
          - task: AzureCLI@2
            inputs:
              azureSubscription: 'U87-PagoPa-PCI-uat(e7feb90c-fcc2-40a2-ba56-d68ec301c6c0)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: | 
                if [ $(SWAP) ]; then
                  for app in $(APP_SERVICES); do
                    echo "SWAPPING $app"
                    az webapp deployment slot swap -s release \
                      --name $app \
                      --resource-group U87-PM-AppServices-pci-uat \
                      --subscription "U87-PagoPa-PCI-uat"
                    if $[ $? == 0 ]; then
                      echo "SWAPPED $app"
                    fi                      
                  done
                fi